import { z } from "zod";

export const shipmentControlSchema = z
  .object({
    id: z.string().optional(),
    organizationId: z.string().optional(),
    businessUnitId: z.string().optional(),
    version: z.number().optional(),
    createdAt: z.number().optional(),
    updatedAt: z.number().optional(),

    // * Core Fields
    enableAutoAssignment: z.boolean(),
    autoAssignmentStrategy: z.string().optional().nullable(),

    // Service Failure Related Fields
    recordServiceFailures: z.boolean().default(false),
    serviceFailureGracePeriod: z.number().optional().nullable(),

    // Delay Shipment Related Fields
    autoDelayShipments: z.boolean(),
    autoDelayShipmentsThreshold: z.number().optional().nullable(),

    // Compliance Controls
    enforceHosCompliance: z.boolean(),
    enforceDriverQualificationCompliance: z.boolean(),
    enforceMedicalCertCompliance: z.boolean(),
    enforceHazmatCompliance: z.boolean(),
    enforceDrugAndAlcoholCompliance: z.boolean(),
    complianceEnforcementLevel: z.string(),

    // Detention Tracking
    trackDetentionTime: z.boolean(),
    autoGenerateDetentionCharges: z.boolean().optional(),
    detentionThreshold: z.number().optional().nullable(),

    // Performance Metrics
    onTimeDeliveryTarget: z.preprocess((val) => {
      if (val === "" || val === null || val === undefined) {
        return undefined;
      }
      const parsed = parseInt(String(val), 10);
      return isNaN(parsed) ? undefined : parsed;
    }, z.number().optional()),
    serviceFailureTarget: z.preprocess((val) => {
      if (val === "" || val === null || val === undefined) {
        return undefined;
      }
      const parsed = parseInt(String(val), 10);
      return isNaN(parsed) ? undefined : parsed;
    }, z.number().optional()),
    trackCustomerRejections: z.boolean(),

    // Misc....
    checkForDuplicateBols: z.boolean(),
    allowMoveRemovals: z.boolean(),
    checkHazmatSegregation: z.boolean(),
  })
  .refine(
    (data) => {
      // If enableAutoAssignment is true, autoAssignmentStrategy must be provided
      if (data.enableAutoAssignment && !data.autoAssignmentStrategy) {
        return false;
      }
      return true;
    },
    {
      message:
        "Auto assignment strategy is required when auto assignment is enabled",
      path: ["autoAssignmentStrategy"],
    },
  )
  .refine(
    (data) => {
      // If recordServiceFailures is true, serviceFailureGracePeriod must be provided
      if (data.recordServiceFailures && !data.serviceFailureGracePeriod) {
        return false;
      }
      return true;
    },
    {
      message:
        "Service failure grace period is required when record service failures is enabled",
      path: ["serviceFailureGracePeriod"],
    },
  )
  .refine(
    (data) => {
      // If autoDelayShipments is true, autoDelayShipmentsThreshold must be provided
      if (data.autoDelayShipments && !data.autoDelayShipmentsThreshold) {
        return false;
      }
      return true;
    },
    {
      message:
        "Auto delay shipments threshold is required when auto delay shipments is enabled",
      path: ["autoDelayShipmentsThreshold"],
    },
  )
  .refine(
    (data) => {
      // If trackDetentionTime is true, autoGenerateDetentionCharges must be provided
      if (
        data.trackDetentionTime &&
        data.autoGenerateDetentionCharges === undefined
      ) {
        return false;
      }
      return true;
    },
    {
      message:
        "Auto generate detention charges is required when track detention time is enabled",
      path: ["autoGenerateDetentionCharges"],
    },
  )
  .refine(
    (data) => {
      // If trackDetentionTime is true, detentionThreshold must be provided
      if (data.trackDetentionTime && !data.detentionThreshold) {
        return false;
      }
      return true;
    },
    {
      message:
        "Detention threshold is required when track detention time is enabled",
      path: ["detentionThreshold"],
    },
  );

export type ShipmentControlSchema = z.infer<typeof shipmentControlSchema>;
