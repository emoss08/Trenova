package repositories

import (
	"context"

	"github.com/emoss08/trenova/internal/core/domain/accounting"
	"github.com/emoss08/trenova/pkg/pagination"
	"github.com/emoss08/trenova/pkg/pulid"
)

type JournalEntryFilterOptions struct {
	IncludeFiscalYear   bool   `form:"includeFiscalYear"`
	IncludeFiscalPeriod bool   `form:"includeFiscalPeriod"`
	IncludeLines        bool   `form:"includeLines"`
	IncludePostedBy     bool   `form:"includePostedBy"`
	IncludeApprovedBy   bool   `form:"includeApprovedBy"`
	Status              string `form:"status"`
	EntryType           string `form:"entryType"`
	FiscalYearID        string `form:"fiscalYearId"`
	FiscalPeriodID      string `form:"fiscalPeriodId"`
	ReferenceType       string `form:"referenceType"`
	ReferenceID         string `form:"referenceId"`
	IsPosted            *bool  `form:"isPosted"`
	IsApproved          *bool  `form:"isApproved"`
	IsReversal          *bool  `form:"isReversal"`
	IsAutoGenerated     *bool  `form:"isAutoGenerated"`
	StartDate           int64  `form:"startDate"`
	EndDate             int64  `form:"endDate"`
}

type ListJournalEntryRequest struct {
	Filter        *pagination.QueryOptions
	FilterOptions JournalEntryFilterOptions `form:"filterOptions"`
}

type GetJournalEntryByIDRequest struct {
	JournalEntryID pulid.ID                  `form:"journalEntryId"`
	OrgID          pulid.ID                  `form:"orgId"`
	BuID           pulid.ID                  `form:"buId"`
	UserID         pulid.ID                  `form:"userId"`
	FilterOptions  JournalEntryFilterOptions `form:"filterOptions"`
}

type GetJournalEntryByNumberRequest struct {
	EntryNumber   string                    `form:"entryNumber"`
	OrgID         pulid.ID                  `form:"orgId"`
	BuID          pulid.ID                  `form:"buId"`
	FilterOptions JournalEntryFilterOptions `form:"filterOptions"`
}

type GetJournalEntriesByReferenceRequest struct {
	ReferenceType string                    `form:"referenceType"`
	ReferenceID   pulid.ID                  `form:"referenceId"`
	OrgID         pulid.ID                  `form:"orgId"`
	BuID          pulid.ID                  `form:"buId"`
	FilterOptions JournalEntryFilterOptions `form:"filterOptions"`
}

type GetJournalEntriesByPeriodRequest struct {
	FiscalPeriodID pulid.ID                  `form:"fiscalPeriodId"`
	OrgID          pulid.ID                  `form:"orgId"`
	BuID           pulid.ID                  `form:"buId"`
	FilterOptions  JournalEntryFilterOptions `form:"filterOptions"`
}

type CreateJournalEntryRequest struct {
	Entry  *accounting.JournalEntry
	UserID pulid.ID
}

type UpdateJournalEntryRequest struct {
	Entry  *accounting.JournalEntry
	UserID pulid.ID
}

type DeleteJournalEntryRequest struct {
	JournalEntryID pulid.ID `form:"journalEntryId"`
	OrgID          pulid.ID `form:"orgId"`
	BuID           pulid.ID `form:"buId"`
	UserID         pulid.ID `form:"userId"`
}

type PostJournalEntryRequest struct {
	JournalEntryID pulid.ID `form:"journalEntryId"`
	OrgID          pulid.ID `form:"orgId"`
	BuID           pulid.ID `form:"buId"`
	UserID         pulid.ID `form:"userId"`
	PostedAt       int64    `form:"postedAt"`
}

type ApproveJournalEntryRequest struct {
	JournalEntryID pulid.ID `form:"journalEntryId"`
	OrgID          pulid.ID `form:"orgId"`
	BuID           pulid.ID `form:"buId"`
	UserID         pulid.ID `form:"userId"`
	ApprovedAt     int64    `form:"approvedAt"`
	ApprovalNotes  string   `form:"approvalNotes"`
}

type RejectJournalEntryRequest struct {
	JournalEntryID pulid.ID `form:"journalEntryId"`
	OrgID          pulid.ID `form:"orgId"`
	BuID           pulid.ID `form:"buId"`
	UserID         pulid.ID `form:"userId"`
	RejectionNotes string   `form:"rejectionNotes"`
}

type ReverseJournalEntryRequest struct {
	JournalEntryID pulid.ID `form:"journalEntryId"`
	OrgID          pulid.ID `form:"orgId"`
	BuID           pulid.ID `form:"buId"`
	UserID         pulid.ID `form:"userId"`
	ReversalDate   int64    `form:"reversalDate"`
	ReversalReason string   `form:"reversalReason"`
}

type JournalEntryRepository interface {
	// Basic CRUD
	List(
		ctx context.Context,
		req *ListJournalEntryRequest,
	) (*pagination.ListResult[*accounting.JournalEntry], error)
	GetByID(
		ctx context.Context,
		req *GetJournalEntryByIDRequest,
	) (*accounting.JournalEntry, error)
	GetByNumber(
		ctx context.Context,
		req *GetJournalEntryByNumberRequest,
	) (*accounting.JournalEntry, error)
	GetByReference(
		ctx context.Context,
		req *GetJournalEntriesByReferenceRequest,
	) ([]*accounting.JournalEntry, error)
	GetByPeriod(
		ctx context.Context,
		req *GetJournalEntriesByPeriodRequest,
	) ([]*accounting.JournalEntry, error)
	Create(ctx context.Context, req *CreateJournalEntryRequest) (*accounting.JournalEntry, error)
	Update(ctx context.Context, req *UpdateJournalEntryRequest) (*accounting.JournalEntry, error)
	Delete(ctx context.Context, req *DeleteJournalEntryRequest) error

	// Status operations
	Post(ctx context.Context, req *PostJournalEntryRequest) (*accounting.JournalEntry, error)
	Approve(ctx context.Context, req *ApproveJournalEntryRequest) (*accounting.JournalEntry, error)
	Reject(ctx context.Context, req *RejectJournalEntryRequest) (*accounting.JournalEntry, error)
	Reverse(ctx context.Context, req *ReverseJournalEntryRequest) (*accounting.JournalEntry, error)

	// Batch operations
	CreateWithLines(
		ctx context.Context,
		entry *accounting.JournalEntry,
		lines []*accounting.JournalEntryLine,
	) (*accounting.JournalEntry, error)
	UpdateWithLines(
		ctx context.Context,
		entry *accounting.JournalEntry,
		lines []*accounting.JournalEntryLine,
	) (*accounting.JournalEntry, error)
}
